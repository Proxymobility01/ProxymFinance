{% extends 'base.html' %}
{% load static %}
{% load humanize %}

{% block title %}Historique des paiements{% endblock %}
{% block page_title %}Historique des paiements{% endblock %}

{% block page_actions %}
<a href="{% url 'payments:centre_paiements' %}" class="btn btn-primary"> 
    <i class="ti ti-cash-banknote"></i> Centre de paiements
</a>
<a href="{% url 'payments:analytique' %}" class="btn btn-info">
    <i class="ti ti-chart-bar"></i> Analytique
</a>
{% endblock %}

{% block content %}
<div class="row">
    <!-- Filtres de recherche -->
    <div class="col-12 mb-4">
        <div class="card">
            <div class="card-header">
                <h3>Filtres de recherche</h3>
            </div>
            <div class="card-body">
                <form method="get" action="{% url 'payments:liste_paiements' %}" class="row" id="filter-form">
                    <div class="col-md-3 mb-3">
                        <label for="q">Recherche</label>
                        <div class="input-group">
                            <input type="text" name="q" id="q" class="form-control" placeholder="Référence, nom, contrat..." value="{{ filtres.q }}">
                            <div class="input-group-append">
                                <button class="btn btn-outline-secondary" type="submit">
                                    <i class="ti ti-search"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-2 mb-3">
                        <label for="date_debut">Date début</label>
                        <input type="date" name="date_debut" id="date_debut" class="form-control" value="{{ filtres.date_debut }}">
                    </div>
                    
                    <div class="col-md-2 mb-3">
                        <label for="date_fin">Date fin</label>
                        <input type="date" name="date_fin" id="date_fin" class="form-control" value="{{ filtres.date_fin }}">
                    </div>
                    
                    <div class="col-md-2 mb-3">
                        <label for="type_contrat">Type de contrat</label>
                        <select name="type_contrat" id="type_contrat" class="form-control">
                            <option value="">Tous les types</option>
                            <option value="chauffeur" {% if filtres.type_contrat == 'chauffeur' %}selected{% endif %}>Chauffeur</option>
                            <option value="partenaire" {% if filtres.type_contrat == 'partenaire' %}selected{% endif %}>Partenaire</option>
                            <option value="batterie" {% if filtres.type_contrat == 'batterie' %}selected{% endif %}>Batterie</option>
                        </select>
                    </div>
                    
                    <div class="col-md-2 mb-3">
                        <label for="methode">Méthode de paiement</label>
                        <select name="methode" id="methode" class="form-control">
                            <option value="">Toutes méthodes</option>
                            {% for code, label in methode_choices %}
                            <option value="{{ code }}" {% if filtres.methode == code %}selected{% endif %}>{{ label }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="col-md-1 mb-3">
                        <label for="penalites" class="d-block">&nbsp;</label>
                        <div class="form-check mt-2">
                            <input type="checkbox" class="form-check-input" id="penalites" name="penalites" value="1" {% if filtres.penalites %}checked{% endif %}>
                            <label class="form-check-label" for="penalites">Pénalités</label>
                        </div>
                    </div>
                    
                    <div class="col-12">
                        <button type="submit" class="btn btn-primary">
                            <i class="ti ti-filter"></i> Filtrer
                        </button>
                        <a href="{% url 'payments:liste_paiements' %}" class="btn btn-outline-secondary">
                            <i class="ti ti-refresh"></i> Réinitialiser
                        </a>
                        <button type="button" id="btnExport" class="btn btn-success float-right">
                            <i class="ti ti-file-spreadsheet"></i> Exporter
                        </button>
                    </div>
                    
                    <!-- Champ caché pour le tri -->
                    <input type="hidden" name="trier_par" id="trier_par" value="{{ filtres.trier_par }}">
                </form>
            </div>
        </div>
    </div>
    
    <!-- Résultats -->
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h3>Paiements ({{ paiements.paginator.count }})</h3>
                <div>
                    <span class="font-weight-bold">Total: {{ total_montant|floatformat:0 }} FCFA</span>
                </div>
            </div>
            <div class="card-body">
                {% if paiements %}
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead>
                                <tr>
                                    <th><a href="#" class="sort-link" data-sort="date_paiement">Date</a></th>
                                    <th><a href="#" class="sort-link" data-sort="reference">Référence</a></th>
                                    <th><a href="#" class="sort-link" data-sort="client">Client</a></th>
                                    <th>Contrat</th>
                                    <th><a href="#" class="sort-link" data-sort="montant">Montant Moto</a></th>
                                    <th><a href="#" class="sort-link" data-sort="montant">Montant Batterie</a></th>
                                    <th><a href="#" class="sort-link" data-sort="montant">Montant Total</a></th>
                                    <th>Méthode</th>
                                    <th>Type</th>
                                    <th>Enregistré par</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for paiement in paiements %}
                                <tr>
                                    <td>
                                      {% if paiement.date_enregistrement %}
                                        {{ paiement.date_enregistrement|date:"d/m/Y H:i" }}
                                      {% else %}
                                        {{ paiement.date_paiement|date:"d/m/Y" }}
                                      {% endif %}
                                    </td>

                                    <td>{{ paiement.reference }}</td>
                                    <td>
                                        {% if paiement.contrat_chauffeur %}
                                            <a href="{% url 'contrats:details_chauffeur' paiement.contrat_chauffeur.association.validated_user.id %}">
                                                {{ paiement.contrat_chauffeur.association.validated_user.prenom }} {{ paiement.contrat_chauffeur.association.validated_user.nom }}
                                            </a>
                                        {% elif paiement.contrat_partenaire %}
                                            <a href="{% url 'contrats:details_partenaire' paiement.contrat_partenaire.partenaire.id %}">
                                                {{ paiement.contrat_partenaire.partenaire.prenom }} {{ paiement.contrat_partenaire.partenaire.nom }}
                                            </a>
                                        {% elif paiement.contrat_batterie.chauffeur %}
                                            <a href="{% url 'contrats:details_chauffeur' paiement.contrat_batterie.chauffeur.id %}">
                                                {{ paiement.contrat_batterie.chauffeur.prenom }} {{ paiement.contrat_batterie.chauffeur.nom }}
                                            </a>
                                        {% elif paiement.contrat_batterie.partenaire %}
                                            <a href="{% url 'contrats:details_partenaire' paiement.contrat_batterie.partenaire.id %}">
                                                {{ paiement.contrat_batterie.partenaire.prenom }} {{ paiement.contrat_batterie.partenaire.nom }}
                                            </a>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if paiement.contrat_chauffeur %}
                                            <a href="{% url 'contrats:details_contrat_chauffeur' paiement.contrat_chauffeur.id %}">
                                                {{ paiement.contrat_chauffeur.reference }}
                                            </a>
                                        {% elif paiement.contrat_partenaire %}
                                            <a href="{% url 'contrats:details_contrat_partenaire' paiement.contrat_partenaire.id %}">
                                                {{ paiement.contrat_partenaire.reference }}
                                            </a>
                                        {% elif paiement.contrat_batterie %}
                                            <a href="{% url 'contrats:details_contrat_batterie' paiement.contrat_batterie.id %}">
                                                {{ paiement.contrat_batterie.reference }}
                                            </a>
                                        {% endif %}
                                    </td>
                                    <td style="text-align: right;">
                                        {{ paiement.montant_moto|default_if_none:"0.00"|floatformat:0|intcomma }} FCFA
                                    </td>
                                    <td style="text-align: right;">
                                        {{ paiement.montant_batterie|default_if_none:"0.00"|floatformat:0|intcomma }} FCFA
                                    </td>
                                    <td style="text-align: right;">
                                        {{ paiement.montant_total|default_if_none:"0.00"|floatformat:0|intcomma }} FCFA
                                    </td>

                                    <td>{{ paiement.get_methode_paiement_display }}</td>
                                    <td>
                                        {% if paiement.est_penalite %}
                                            <span class="badge badge-danger">Pénalité</span>
                                        {% else %}
                                            <span class="badge badge-primary">{{ paiement.get_type_contrat_display }}</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if paiement.enregistre_par %}
                                            {{ paiement.enregistre_par.prenom }} {{ paiement.enregistre_par.nom }}
                                        {% else %}
                                            {{ paiement.user_agence.prenom }} {{ paiement.user_agence.nom }}
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    
                    {% if paiements.paginator.num_pages > 1 %}
                    <div class="pagination-container mt-4">
                        <nav aria-label="Pagination">
                            <ul class="pagination justify-content-center">
                                {% if paiements.has_previous %}
                                <li class="page-item">
                                    <a class="page-link" href="?page=1{{ request.GET.urlencode|cut:'page=' }}" aria-label="Début">
                                        <i class="ti ti-chevrons-left"></i>
                                    </a>
                                </li>
                                <li class="page-item">
                                    <a class="page-link" href="?page={{ paiements.previous_page_number }}{{ request.GET.urlencode|cut:'page=' }}" aria-label="Précédent">
                                        <i class="ti ti-chevron-left"></i>
                                    </a>
                                </li>
                                {% endif %}

                                {% for num in paiements.paginator.page_range %}
                                {% if paiements.number == num %}
                                <li class="page-item active"><a class="page-link" href="#">{{ num }}</a></li>
                                {% elif num > paiements.number|add:'-3' and num < paiements.number|add:'3' %}
                                <li class="page-item">
                                    <a class="page-link" href="?page={{ num }}{{ request.GET.urlencode|cut:'page=' }}">{{ num }}</a>
                                </li>
                                {% endif %}
                                {% endfor %}

                                {% if paiements.has_next %}
                                <li class="page-item">
                                    <a class="page-link" href="?page={{ paiements.next_page_number }}{{ request.GET.urlencode|cut:'page=' }}" aria-label="Suivant">
                                        <i class="ti ti-chevron-right"></i>
                                    </a>
                                </li>
                                <li class="page-item">
                                    <a class="page-link" href="?page={{ paiements.paginator.num_pages }}{{ request.GET.urlencode|cut:'page=' }}" aria-label="Fin">
                                        <i class="ti ti-chevrons-right"></i>
                                    </a>
                                </li>
                                {% endif %}
                            </ul>
                        </nav>
                    </div>
                    {% endif %}

                    
                {% else %}
                    <div class="alert alert-info">
                        <i class="ti ti-info-circle"></i> Aucun paiement ne correspond aux critères de recherche.
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Fonctionnalité d'exportation
        document.getElementById('btnExport').addEventListener('click', function() {
            // Construire l'URL pour l'exportation avec les filtres actuels
            let filterForm = document.getElementById('filter-form');
            let formData = new FormData(filterForm);
            
            // Ajouter le paramètre d'exportation
            formData.append('export', 'csv');
            
            // Convertir FormData en paramètres URL
            const params = new URLSearchParams(formData);
            
            // Rediriger vers l'URL d'exportation
            window.location.href = filterForm.action + '?' + params.toString();
        });
        
        // Gestion du tri
        document.querySelectorAll('.sort-link').forEach(function(element) {
            element.addEventListener('click', function(e) {
                e.preventDefault();
                
                let sortField = this.getAttribute('data-sort');
                let currentSort = document.getElementById('trier_par').value;
                
                // Si le même champ est déjà trié, inverser l'ordre
                if (currentSort === sortField) {
                    document.getElementById('trier_par').value = '-' + sortField;
                } else if (currentSort === '-' + sortField) {
                    document.getElementById('trier_par').value = sortField;
                } else {
                    // Premier tri sur ce champ (ordre ascendant par défaut)
                    document.getElementById('trier_par').value = sortField;
                }
                
                // Soumettre le formulaire
                document.getElementById('filter-form').submit();
            });
        });
        
        // Initialiser la datatable si nécessaire
        if (typeof $.fn.DataTable !== 'undefined') {
            $('.table').DataTable({
                "paging": false,  // Désactiver la pagination de DataTable car nous utilisons notre propre système
                "info": false,    // Désactiver l'affichage d'informations
                "searching": false, // Désactiver la recherche car nous avons notre propre filtre
                "ordering": false,  // Désactiver le tri de DataTable car nous avons notre propre système
                "language": {
                    "url": "{% static 'js/datatables.french.json' %}"
                }
            });
        }
    });
</script>

{% endblock %}