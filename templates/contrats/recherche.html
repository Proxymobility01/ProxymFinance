{% extends 'base.html' %}
{% load static %}

{% block title %}Recherche de Contrats{% endblock %}
{% block page_title %}Recherche de Contrats{% endblock %}

{% block page_actions %}
<a href="{% url 'contrats:dashboard' %}" class="btn btn-secondary">
    <i class="ti ti-arrow-left"></i> Retour
</a>
{% endblock %}

{% block content %}
<div class="card mb-4">
    <div class="card-header">
        <h3>Filtres de recherche</h3>
    </div>
    <div class="card-body">
        <form action="" method="get" class="row">
            <div class="col-md-3 mb-3">
                <label for="q">Terme de recherche</label>
                <input type="text" name="q" id="q" class="form-control" placeholder="Référence, nom..." value="{{ query }}">
            </div>
            <div class="col-md-3 mb-3">
                <label for="type">Type de contrat</label>
                <select name="type" id="type" class="form-control">
                    <option value="tous" {% if type_contrat == 'tous' %}selected{% endif %}>Tous les types</option>
                    <option value="chauffeur" {% if type_contrat == 'chauffeur' %}selected{% endif %}>Contrats Chauffeur</option>
                    <option value="partenaire" {% if type_contrat == 'partenaire' %}selected{% endif %}>Contrats Partenaire</option>
                    <option value="batterie" {% if type_contrat == 'batterie' %}selected{% endif %}>Contrats Batterie</option>
                </select>
            </div>
            <div class="col-md-3 mb-3">
                <label for="statut">Statut</label>
                <select name="statut" id="statut" class="form-control">
                    <option value="" {% if statut == '' %}selected{% endif %}>Tous les statuts</option>
                    <option value="actif" {% if statut == 'actif' %}selected{% endif %}>Actif</option>
                    <option value="suspendu" {% if statut == 'suspendu' %}selected{% endif %}>Suspendu</option>
                    <option value="terminé" {% if statut == 'terminé' %}selected{% endif %}>Terminé</option>
                </select>
            </div>
            <div class="col-md-3 mb-3">
                <label for="date_debut">Date début</label>
                <input type="date" name="date_debut" id="date_debut" class="form-control" value="{{ date_debut }}">
            </div>
            <div class="col-md-3 mb-3">
                <label for="date_fin">Date fin</label>
                <input type="date" name="date_fin" id="date_fin" class="form-control" value="{{ date_fin }}">
            </div>
            <div class="col-md-3 mb-3">
                <label class="d-block">&nbsp;</label>
                <button type="submit" class="btn btn-primary w-100">
                    <i class="ti ti-search"></i> Rechercher
                </button>
            </div>
            <div class="col-md-3 mb-3">
                <label class="d-block">&nbsp;</label>
                <a href="{% url 'contrats:recherche_contrats' %}" class="btn btn-secondary w-100">
                    <i class="ti ti-refresh"></i> Réinitialiser
                </a>
            </div>
        </form>
    </div>
</div>

<!-- Résultats Contrats Chauffeur -->
{% if type_contrat == '' or type_contrat == 'chauffeur' or type_contrat == 'tous' %}
<div class="card mb-4">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h3>Contrats Chauffeur</h3>
        <span class="badge badge-primary">{{ resultats_chauffeur.count }}</span>
    </div>
    <div class="card-body">
        {% if resultats_chauffeur %}
        <div class="table-responsive">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>Référence</th>
                        <th>Chauffeur</th>
                        <th>Moto</th>
                        <th>Date Signature</th>
                        <th>Montant</th>
                        <th>Statut</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for contrat in resultats_chauffeur %}
                    <tr>
                        <td>{{ contrat.reference }}</td>
                        <td>
                            {% if contrat.association and contrat.association.validated_user %}
                                <a href="{% url 'contrats:details_chauffeur' contrat.association.validated_user.id %}">
                                    {{ contrat.association.validated_user.nom }} {{ contrat.association.validated_user.prenom }}
                                </a>
                            {% else %}
                                <span class="text-muted">Chauffeur inconnu</span>
                            {% endif %}

                        </td>
                        <td>{{ contrat.moto.model }} ({{ contrat.moto.vin|slice:"-6:" }})</td>
                        <td>{{ contrat.date_signature|date:"d/m/Y" }}</td>
                        <td>{{ contrat.montant_total|floatformat:0 }} FCFA</td>
                        <td>
                            {% if contrat.statut == 'actif' %}
                                <span class="badge badge-success">Actif</span>
                            {% elif contrat.statut == 'terminé' %}
                                <span class="badge badge-danger">Terminé</span>
                            {% else %}
                                <span class="badge badge-warning">Suspendu</span>
                            {% endif %}
                        </td>
                        <td>
                            <a href="{% url 'contrats:details_contrat_chauffeur' contrat.id %}" class="btn btn-sm btn-info" title="Détails">
                                <i class="ti ti-eye"></i>
                            </a>
                            <a href="{% url 'contrats:modifier_contrat_chauffeur' contrat.id %}" class="btn btn-sm btn-warning" title="Modifier">
                                <i class="ti ti-edit"></i>
                            </a>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="text-center py-4">
            <i class="ti ti-file-off" style="font-size: 48px; opacity: 0.5;"></i>
            <p class="mt-3">Aucun contrat chauffeur trouvé.</p>
        </div>
        {% endif %}
    </div>
</div>
{% endif %}

<!-- Résultats Contrats Partenaire -->
{% if type_contrat == '' or type_contrat == 'partenaire' or type_contrat == 'tous' %}
<div class="card mb-4">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h3>Contrats Partenaire</h3>
        <span class="badge badge-primary">{{ resultats_partenaire.count }}</span>
    </div>
    <div class="card-body">
        {% if resultats_partenaire %}
        <div class="table-responsive">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>Référence</th>
                        <th>Partenaire</th>
                        <th>Motos</th>
                        <th>Date Signature</th>
                        <th>Montant</th>
                        <th>Statut</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for contrat in resultats_partenaire %}
                    <tr>
                        <td>{{ contrat.reference }}</td>
                        <td>{{ contrat.partenaire.nom }} {{ contrat.partenaire.prenom }}</td>
                        <td>{{ contrat.motos.count }}</td>
                        <td>{{ contrat.date_signature|date:"d/m/Y" }}</td>
                        <td>{{ contrat.montant_total|floatformat:0 }} FCFA</td>
                        <td>
                            {% if contrat.statut == 'actif' %}
                                <span class="badge badge-success">Actif</span>
                            {% elif contrat.statut == 'terminé' %}
                                <span class="badge badge-danger">Terminé</span>
                            {% else %}
                                <span class="badge badge-warning">Suspendu</span>
                            {% endif %}
                        </td>
                        <td>
                            <a href="{% url 'contrats:details_contrat_partenaire' contrat.id %}" class="btn btn-sm btn-info" title="Détails">
                                <i class="ti ti-eye"></i>
                            </a>
                            <a href="{% url 'contrats:modifier_contrat_partenaire' contrat.id %}" class="btn btn-sm btn-warning" title="Modifier">
                                <i class="ti ti-edit"></i>
                            </a>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="text-center py-4">
            <i class="ti ti-file-off" style="font-size: 48px; opacity: 0.5;"></i>
            <p class="mt-3">Aucun contrat partenaire trouvé.</p>
        </div>
        {% endif %}
    </div>
</div>
{% endif %}

<!-- Résultats Contrats Batterie -->
{% if type_contrat == '' or type_contrat == 'batterie' or type_contrat == 'tous' %}
<div class="card mb-4">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h3>Contrats Batterie</h3>
        <span class="badge badge-primary">{{ resultats_batterie.count }}</span>
    </div>
    <div class="card-body">
        {% if resultats_batterie %}
        <div class="table-responsive">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>Référence</th>
                        <th>Chauffeur</th>
                        <th>Batterie</th>
                        <th>Date Signature</th>
                        <th>Montant</th>
                        <th>Statut</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for contrat in resultats_batterie %}
                    <tr>
                        <td>{{ contrat.reference }}</td>
                        <td>
                            {% if contrat.association and contrat.association.validated_user %}
                                <a href="{% url 'contrats:details_chauffeur' contrat.association.validated_user.id %}">
                                    {{ contrat.association.validated_user.nom }} {{ contrat.association.validated_user.prenom }}
                                </a>
                            {% else %}
                                <span class="text-muted">Chauffeur inconnu</span>
                            {% endif %}
                        </td>
                        <td>{{ contrat.batterie }}</td>
                        <td>{{ contrat.date_signature|date:"d/m/Y" }}</td>
                        <td>{{ contrat.montant_total|floatformat:0 }} FCFA</td>
                        <td>
                            {% if contrat.statut == 'actif' %}
                                <span class="badge badge-success">Actif</span>
                            {% elif contrat.statut == 'terminé' %}
                                <span class="badge badge-danger">Terminé</span>
                            {% else %}
                                <span class="badge badge-warning">Suspendu</span>
                            {% endif %}
                        </td>
                        <td>
                            <a href="{% url 'contrats:details_contrat_batterie' contrat.id %}" class="btn btn-sm btn-info" title="Détails">
                                <i class="ti ti-eye"></i>
                            </a>
                            <a href="{% url 'contrats:modifier_contrat_batterie' contrat.id %}" class="btn btn-sm btn-warning" title="Modifier">
                                <i class="ti ti-edit"></i>
                            </a>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="text-center py-4">
            <i class="ti ti-file-off" style="font-size: 48px; opacity: 0.5;"></i>
            <p class="mt-3">Aucun contrat batterie trouvé.</p>
        </div>
        {% endif %}
    </div>
</div>
{% endif %}

<!-- Aucun résultat global -->
{% if not resultats_chauffeur and not resultats_partenaire and not resultats_batterie %}
<div class="card">
    <div class="card-body text-center py-5">
        <i class="ti ti-search-off" style="font-size: 64px; opacity: 0.5;"></i>
        <h4 class="mt-3">Aucun résultat trouvé</h4>
        <p>Aucun contrat ne correspond à vos critères de recherche.</p>
        <a href="{% url 'contrats:recherche_contrats' %}" class="btn btn-primary mt-2">
            <i class="ti ti-refresh"></i> Réinitialiser les filtres
        </a>
    </div>
</div>
{% endif %}
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Validation des dates
        const dateDebutInput = document.getElementById('date_debut');
        const dateFinInput = document.getElementById('date_fin');
        
        if (dateDebutInput && dateFinInput) {
            dateFinInput.addEventListener('change', function() {
                if (dateDebutInput.value && dateFinInput.value) {
                    const dateDebut = new Date(dateDebutInput.value);
                    const dateFin = new Date(dateFinInput.value);
                    
                    if (dateFin < dateDebut) {
                        alert('La date de fin ne peut pas être antérieure à la date de début.');
                        dateFinInput.value = '';
                    }
                }
            });
        }
        
        // Gestion de l'affichage en fonction du type de contrat sélectionné
        const typeSelect = document.getElementById('type');
        if (typeSelect) {
            typeSelect.addEventListener('change', function() {
                // Si on implémente un changement dynamique de l'UI en fonction du type sélectionné
                // Par exemple, afficher/masquer certains filtres
            });
        }
    });
</script>
{% endblock %}