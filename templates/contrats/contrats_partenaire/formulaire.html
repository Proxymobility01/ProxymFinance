{% extends 'base.html' %}
{% load static %}

{% block title %}{{ titre }}{% endblock %}
{% block page_title %}{{ titre }}{% endblock %}

{% block page_actions %}
<a href="{% url 'contrats:liste_contrats_partenaire' %}" class="btn btn-secondary">
    <i class="ti ti-arrow-left"></i> Retour
</a>
{% endblock %}

{% block content %}
<div class="card">
    <div class="card-header">
        <h3>{{ action }} un contrat partenaire</h3>
    </div>
    <div class="card-body">
        <form method="post" enctype="multipart/form-data">
            {% csrf_token %}
            
            {% if form.errors %}
            <div class="alert alert-danger">
                <strong>Des erreurs ont été détectées dans le formulaire:</strong>
                <ul>
                    {% for field in form %}
                        {% for error in field.errors %}
                            <li>{{ field.label }}: {{ error }}</li>
                        {% endfor %}
                    {% endfor %}
                    {% for error in form.non_field_errors %}
                        <li>{{ error }}</li>
                    {% endfor %}
                </ul>
            </div>
            {% endif %}
            
            <div class="row">
                <!-- Informations de base -->
                <div class="col-md-6">
                    <h4 class="mb-3">Informations de base</h4>
                    
                    <div class="form-group">
                        <label for="{{ form.reference.id_for_label }}">{{ form.reference.label }}</label>
                        {{ form.reference }}
                        {% if form.reference.help_text %}
                            <small class="form-text text-muted">{{ form.reference.help_text }}</small>
                        {% endif %}
                    </div>
                    
                    <div class="form-group">
                        <label for="{{ form.partenaire.id_for_label }}">{{ form.partenaire.label }}</label>
                        {{ form.partenaire }}
                        <div class="mt-2">
                            <a href="{% url 'contrats:ajouter_partenaire' %}" class="btn btn-sm btn-outline-primary" id="addPartenaireBtn">
                                <i class="ti ti-plus"></i> Ajouter un nouveau partenaire
                            </a>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="{{ form.motos.id_for_label }}">Motos associées</label>
                        {{ form.motos }}
                        <small class="form-text text-muted">Sélectionnez les motos à associer à ce contrat</small>
                    </div>
                    
                    <div class="form-group">
                        <label for="{{ form.montant_total.id_for_label }}">{{ form.montant_total.label }}</label>
                        {{ form.montant_total }}
                    </div>
                    <!-- Dans la section "Informations de base", après montant_total -->
                    <div class="form-group">
                        <label for="{{ form.montant_engage.id_for_label }}">{{ form.montant_engage.label }}</label>
                        {{ form.montant_engage }}
                        {% if form.montant_engage.help_text %}
                            <small class="form-text text-muted">{{ form.montant_engage.help_text }}</small>
                        {% endif %}
                        {% if form.montant_engage.errors %}
                            <div class="invalid-feedback">{{ form.montant_engage.errors }}</div>
                        {% endif %}
                    </div> 
                    <div class="form-group">
                        <label for="{{ form.frequence_paiement.id_for_label }}">{{ form.frequence_paiement.label }}</label>
                        {{ form.frequence_paiement }}
                    </div>
                    
                    <div class="form-group">
                        <label for="{{ form.montant_caution_batterie.id_for_label }}">{{ form.montant_caution_batterie.label }}</label>
                        {{ form.montant_caution_batterie }}
                        <small class="form-text text-muted">Calculé automatiquement selon le nombre de motos</small>
                    </div>
                    <div class="form-group">
                        <label for="{{ form.montant_engage_batterie.id_for_label }}">{{ form.montant_engage_batterie.label }}</label>
                        {{ form.montant_engage_batterie }}
                        {% if form.montant_engage_batterie.help_text %}
                            <small class="form-text text-muted">{{ form.montant_engage_batterie.help_text }}</small>
                        {% endif %}
                        {% if form.montant_engage_batterie.errors %}
                            <div class="invalid-feedback">{{ form.montant_engage_batterie.errors }}</div>
                        {% endif %}
                    </div>
                </div>
                
                <!-- Détails du contrat -->
                <div class="col-md-6">
                    <h4 class="mb-3">Détails du contrat</h4>
                    
                    <div class="form-group">
                        <label for="{{ form.date_signature.id_for_label }}">{{ form.date_signature.label }}</label>
                        {{ form.date_signature }}
                    </div>
                    
                    <div class="form-group">
                        <label for="{{ form.date_debut.id_for_label }}">{{ form.date_debut.label }}</label>
                        {{ form.date_debut }}
                    </div>
                    
                    <div class="form-group">
                        <label for="{{ form.duree_semaines.id_for_label }}">{{ form.duree_semaines.label }}</label>
                        {{ form.duree_semaines }}
                        <small class="form-text text-muted">La date de fin sera calculée automatiquement</small>
                    </div>
                    
                    <div class="form-group">
                        <label for="{{ form.duree_caution_batterie.id_for_label }}">{{ form.duree_caution_batterie.label }}</label>
                        {{ form.duree_caution_batterie }}
                    </div>
                    
                    <div class="form-group">
                        <label for="{{ form.cni_document.id_for_label }}">{{ form.cni_document.label }}</label>
                        {{ form.cni_document }}
                        {% if contrat.cni_document %}
                            <div class="mt-2">
                                <a href="{{ contrat.cni_document.url }}" target="_blank" class="btn btn-sm btn-info">
                                    <i class="ti ti-file"></i> Voir le document
                                </a>
                            </div>
                        {% endif %}
                    </div>
                    
                    <div class="form-group">
                        <label for="{{ form.plan_localisation.id_for_label }}">{{ form.plan_localisation.label }}</label>
                        {{ form.plan_localisation }}
                        {% if contrat.plan_localisation %}
                            <div class="mt-2">
                                <a href="{{ contrat.plan_localisation.url }}" target="_blank" class="btn btn-sm btn-info">
                                    <i class="ti ti-file"></i> Voir le document
                                </a>
                            </div>
                        {% endif %}
                    </div>
                    
                    <div class="form-group">
                        <label for="{{ form.contrat_physique.id_for_label }}">{{ form.contrat_physique.label }}</label>
                        {{ form.contrat_physique }}
                        {% if contrat.contrat_physique %}
                            <div class="mt-2">
                                <a href="{{ contrat.contrat_physique.url }}" target="_blank" class="btn btn-sm btn-info">
                                    <i class="ti ti-file"></i> Voir le document
                                </a>
                            </div>
                        {% endif %}
                    </div>
                    
                    <div class="form-group">
                        <label for="{{ form.statut.id_for_label }}">{{ form.statut.label }}</label>
                        {{ form.statut }}
                    </div>
                </div>
            </div>
            
            <div class="form-group mt-4 text-center">
                <button type="submit" class="btn btn-primary">
                    <i class="ti ti-device-floppy"></i> {{ action }}
                </button>
                <a href="{% url 'contrats:liste_contrats_partenaire' %}" class="btn btn-secondary">
                    <i class="ti ti-x"></i> Annuler
                </a>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Ajouter la classe form-control à tous les champs du formulaire
        const formInputs = document.querySelectorAll('input, select, textarea');
        formInputs.forEach(input => {
            if (!input.classList.contains('form-control')) {
                input.classList.add('form-control');
            }
        });
        
        // Initialiser les sélecteurs avec recherche
        const selects = document.querySelectorAll('select.select2');
        selects.forEach(select => {
            // Ici on pourrait initialiser Select2 ou un autre plugin si disponible
        });
        
        // Ajouter une confirmation avant de quitter si le formulaire a été modifié
        const form = document.querySelector('form');
        let formModified = false;
        
        // Marquer le formulaire comme modifié lorsqu'un champ change
        form.addEventListener('input', function() {
            formModified = true;
        });
        
        // Confirmation avant de quitter si le formulaire est modifié
        window.addEventListener('beforeunload', function(e) {
            if (formModified) {
                e.preventDefault();
                e.returnValue = '';
                return '';
            }
        });
        
        // Désactiver la confirmation sur soumission du formulaire
        form.addEventListener('submit', function() {
            formModified = false;
        });
        
        // Calcul automatique du montant par paiement
        const montantTotalInput = document.querySelector('input[name="montant_total"]');
        const frequencePaiementSelect = document.querySelector('select[name="frequence_paiement"]');
        const dureeSemainesInput = document.querySelector('input[name="duree_semaines"]');
        
        function calculerMontantParPaiement() {
            const montantTotal = parseFloat(montantTotalInput.value) || 0;
            const duree = parseInt(dureeSemainesInput.value) || 61;
            const frequence = frequencePaiementSelect.value;
            
            let montantParPaiement = 0;
            const totalJours = duree * 6; // 6 jours par semaine
            
            if (frequence === 'journalier') {
                montantParPaiement = montantTotal / totalJours;
            } else if (frequence === 'hebdomadaire') {
                montantParPaiement = montantTotal / duree;
            } else if (frequence === 'mensuel') {
                montantParPaiement = montantTotal / (duree / 4);
            } else if (frequence === 'trimestriel') {
                montantParPaiement = montantTotal / (duree / 13);
            }
            
            // Afficher le montant calculé
            const infoElement = document.createElement('div');
            infoElement.className = 'mt-2 alert alert-info';
            infoElement.innerHTML = `<strong>Montant par paiement estimé:</strong> ${Math.round(montantParPaiement).toLocaleString()} FCFA`;
            
            const existingInfo = frequencePaiementSelect.parentNode.querySelector('.alert-info');
            if (existingInfo) {
                existingInfo.remove();
            }
            
            frequencePaiementSelect.parentNode.appendChild(infoElement);
        }
        
        // Écouter les changements sur les champs concernés
        if (montantTotalInput && frequencePaiementSelect && dureeSemainesInput) {
            montantTotalInput.addEventListener('change', calculerMontantParPaiement);
            frequencePaiementSelect.addEventListener('change', calculerMontantParPaiement);
            dureeSemainesInput.addEventListener('change', calculerMontantParPaiement);
            
            // Calculer au chargement de la page
            calculerMontantParPaiement();
        }
        
        // Gestion du nombre de motos sélectionnées et calcul de la caution
        const motosSelect = document.querySelector('select[name="motos"]');
        const cautionInput = document.querySelector('input[name="montant_caution_batterie"]');
        
        if (motosSelect && cautionInput) {
            // Calculer la caution basée sur le nombre de motos
            function calculerCaution() {
                const nombreMotos = motosSelect.selectedOptions.length;
                const montantCaution = nombreMotos * 50000; // 50 000 FCFA par moto
                cautionInput.value = montantCaution;
            }
            
            // Recalculer à chaque changement de sélection
            motosSelect.addEventListener('change', calculerCaution);
            
            // Calculer au chargement initial
            calculerCaution();
        }
    });
</script>
{% endblock %}