{% extends 'base.html' %}
{% load static %}

{% block title %}Liste des Congés{% endblock %}
{% block page_title %}Liste des Congés{% endblock %}

{% block extra_css %}
<style>
    /* Badges pour les différents statuts */
    .badge {
        padding: 0.4em 0.6em;
        font-size: 0.75rem;
        font-weight: 500;
        border-radius: 0.25rem;
    }

    .badge-warning {
        background-color: #ffb74d;
        color: #212529;
    }

    .badge-success {
        background-color: #4caf50;
        color: #fff;
    }

    .badge-info {
        background-color: #2196f3;
        color: #fff;
    }

    .badge-primary {
        background-color: #3f51b5;
        color: #fff;
    }

    .badge-secondary {
        background-color: #607d8b;
        color: #fff;
    }

    .badge-danger {
        background-color: #f44336;
        color: #fff;
    }

    /* Buttons */
    .btn-sm {
        padding: 0.25rem 0.5rem;
        font-size: 0.875rem;
    }

    .btn-success {
        background-color: #4caf50;
        border-color: #4caf50;
    }

    .btn-danger {
        background-color: #f44336;
        border-color: #f44336;
    }

    /* Table */
    .table-hover tbody tr:hover {
        background-color: rgba(0, 0, 0, 0.04);
    }

    /* Filter Panel */
    .filter-panel {
        background-color: var(--border-color);
        border-radius: 0.25rem;
        padding: 1rem;
        margin-bottom: 1.5rem;
    }

    /* Empty state */
    .empty-state {
        color: #6c757d;
    }
</style>
{% endblock %}

{% block page_actions %}
<a href="{% url 'contrats:ajouter_conge' %}" class="btn btn-primary">
    <i class="ti ti-plus"></i> Nouvelle demande de congé
</a>
{% endblock %}

{% block content %}
<div class="card">
    <div class="card-header">
        <div class="row align-items-center">
            <div class="col">
                <h3>Congés</h3>
            </div>
        </div>
    </div>
    <div class="card-body">
        <!-- Messages -->
        {% if messages %}
        <div class="messages mb-4">
            {% for message in messages %}
            <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                {{ message }}
                <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            {% endfor %}
        </div>
        {% endif %}

        <!-- Filtre -->
        <div class="filter-panel mb-4">
            <form action="{% url 'contrats:liste_conges' %}" method="get" class="row">
                <div class="col-md-4 mb-2">
                    <label for="statut" class="form-label">Statut</label>
                    <select name="statut" id="statut" class="form-control">
                        <option value="">Tous les statuts</option>
                        <option value="en_attente" {% if statut_filter == 'en_attente' %}selected{% endif %}>En attente</option>
                        <option value="approuvé" {% if statut_filter == 'approuvé' %}selected{% endif %}>Approuvés</option>
                        <option value="planifié" {% if statut_filter == 'planifié' %}selected{% endif %}>Planifiés</option>
                        <option value="en_cours" {% if statut_filter == 'en_cours' %}selected{% endif %}>En cours</option>
                        <option value="terminé" {% if statut_filter == 'terminé' %}selected{% endif %}>Terminés</option>
                        <option value="annulé" {% if statut_filter == 'annulé' %}selected{% endif %}>Annulés</option>
                        <option value="rejeté" {% if statut_filter == 'rejeté' %}selected{% endif %}>Rejetés</option>
                    </select>
                </div>
                <div class="col-md-4 mb-2">
                    <label for="periode" class="form-label">Période</label>
                    <select name="periode" id="periode" class="form-control">
                        <option value="">Toutes les périodes</option>
                        <option value="en_cours" {% if periode_filter == 'en_cours' %}selected{% endif %}>En cours</option>
                        <option value="a_venir" {% if periode_filter == 'a_venir' %}selected{% endif %}>À venir</option>
                        <option value="termines" {% if periode_filter == 'termines' %}selected{% endif %}>Terminés</option>
                    </select>
                </div>
                <div class="col-md-4 mb-2">
                    <label class="form-label d-block">&nbsp;</label>
                    <button type="submit" class="btn btn-primary w-100">
                        <i class="ti ti-filter"></i> Filtrer
                    </button>
                </div>
            </form>
        </div>
        
        {% if conges %}
        <div class="table-responsive">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>Chauffeur</th>
                        <th>Contrat</th>
                        <th>Période</th>
                        <th>Jours</th>
                        <th>Statut</th>
                        <th>Date demande</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for conge in conges %}
                    <tr>
                        <td>
                            {% if conge.contrat.association and conge.contrat.association.validated_user %}
                                <a href="{% url 'contrats:details_chauffeur' conge.contrat.association.validated_user.id %}">
                                    {{ conge.contrat.association.validated_user.nom }} {{ conge.contrat.association.validated_user.prenom }}
                                </a>
                            {% else %}
                                <span class="text-danger">Aucun chauffeur</span>
                            {% endif %}


                        </td>

                        <td>
                            <a href="{% url 'contrats:details_contrat_chauffeur' conge.contrat.id %}">
                                {{ conge.contrat.reference }}
                            </a>
                        </td>
                        <td>{{ conge.date_debut|date:"d/m/Y" }} - {{ conge.date_fin|date:"d/m/Y" }}</td>
                        <td>{{ conge.nombre_jours }}</td>
                        <td>
                            {% if conge.statut == 'en_attente' %}
                                <span class="badge badge-warning">En attente</span>
                            {% elif conge.statut == 'approuvé' %}
                                <span class="badge badge-success">Approuvé</span>
                            {% elif conge.statut == 'planifié' %}
                                <span class="badge badge-info">Planifié</span>
                            {% elif conge.statut == 'en_cours' %}
                                <span class="badge badge-primary">En cours</span>
                            {% elif conge.statut == 'terminé' %}
                                <span class="badge badge-secondary">Terminé</span>
                            {% elif conge.statut == 'annulé' %}
                                <span class="badge badge-danger">Annulé</span>
                            {% elif conge.statut == 'rejeté' %}
                                <span class="badge badge-danger">Rejeté</span>
                            {% endif %}
                        </td>
                        <td>{{ conge.date_demande|date:"d/m/Y" }}</td>
                        <td>
                            <a href="{% url 'contrats:details_conge' conge.id %}" class="btn btn-sm btn-info" title="Détails">
                                <i class="ti ti-eye"></i>
                            </a>
                            {% if conge.statut == 'en_attente' %}
                                <button type="button" class="btn btn-sm btn-success btn-approuver" data-id="{{ conge.id }}" title="Approuver">
                                    <i class="ti ti-check"></i>
                                </button>
                                <button type="button" class="btn btn-sm btn-danger btn-rejeter" data-id="{{ conge.id }}" title="Rejeter">
                                    <i class="ti ti-x"></i>
                                </button>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="text-center py-4 empty-state">
            <i class="ti ti-calendar-off" style="font-size: 48px; opacity: 0.5;"></i>
            <p class="mt-3">Aucun congé trouvé.</p>
            <a href="{% url 'contrats:ajouter_conge' %}" class="btn btn-primary mt-2">
                <i class="ti ti-plus"></i> Demander un congé
            </a>
        </div>
        {% endif %}
    </div>
</div>

<!-- Modal Approuver -->
<div class="modal fade" id="approuverCongeModal" tabindex="-1" role="dialog" aria-hidden="true" style="display: none;">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Approuver la demande de congé</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <form action="" method="post" id="approuverForm">
                {% csrf_token %}
                <div class="modal-body">
                    <input type="hidden" name="statut" value="approuvé">
                    <div class="form-group">
                        <label for="commentaire-approuver">Commentaire (optionnel):</label>
                        <textarea id="commentaire-approuver" name="commentaire" class="form-control" rows="3"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Annuler</button>
                    <button type="submit" class="btn btn-success">Approuver</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal Rejeter -->
<div class="modal fade" id="rejeterCongeModal" tabindex="-1" role="dialog" aria-hidden="true" style="display: none;">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Rejeter la demande de congé</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <form action="" method="post" id="rejeterForm">
                {% csrf_token %}
                <div class="modal-body">
                    <input type="hidden" name="statut" value="rejeté">
                    <div class="form-group">
                        <label for="commentaire-rejeter">Motif de refus:</label>
                        <textarea id="commentaire-rejeter" name="commentaire" class="form-control" rows="3" required></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Annuler</button>
                    <button type="submit" class="btn btn-danger">Rejeter</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Overlay pour l'arrière-plan des modales -->
<div class="modal-backdrop fade" id="modal-backdrop" style="display: none;"></div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const modalBackdrop = document.getElementById('modal-backdrop');
        
        // Modales
        const approuverModal = document.getElementById('approuverCongeModal');
        const rejeterModal = document.getElementById('rejeterCongeModal');
        
        // Boutons d'action
        const btnsApprouver = document.querySelectorAll('.btn-approuver');
        const btnsRejeter = document.querySelectorAll('.btn-rejeter');
        
        // Fonction pour ouvrir une modale
        function openModal(modal, congeId) {
            // Définir l'URL du formulaire
            const form = modal.querySelector('form');
            form.action = "{% url 'contrats:modifier_statut_conge' 0 %}".replace('0', congeId);
            
            // Afficher la modale et l'overlay
            modal.style.display = 'block';
            setTimeout(() => {
                modal.classList.add('show');
            }, 10);
            
            modalBackdrop.style.display = 'block';
            setTimeout(() => {
                modalBackdrop.classList.add('show');
            }, 10);
            
            document.body.classList.add('modal-open');
            document.body.style.overflow = 'hidden';
            document.body.style.paddingRight = '15px';

            // Mettre le focus sur le premier champ de texte (amélioration UX)
            const textarea = modal.querySelector('textarea');
            if (textarea) {
                setTimeout(() => {
                    textarea.focus();
                }, 300);
            }
        }
        
        // Fonction pour fermer une modale
        function closeModal(modal) {
            if (!modal) return;
            
            modal.classList.remove('show');
            setTimeout(() => {
                modal.style.display = 'none';
            }, 150);
            
            modalBackdrop.classList.remove('show');
            setTimeout(() => {
                modalBackdrop.style.display = 'none';
            }, 150);
            
            document.body.classList.remove('modal-open');
            document.body.style.overflow = '';
            document.body.style.paddingRight = '';
        }
        
        // Gestionnaires pour les boutons d'approbation
        btnsApprouver.forEach(btn => {
            btn.addEventListener('click', function() {
                const congeId = this.getAttribute('data-id');
                openModal(approuverModal, congeId);
            });
        });
        
        // Gestionnaires pour les boutons de rejet
        btnsRejeter.forEach(btn => {
            btn.addEventListener('click', function() {
                const congeId = this.getAttribute('data-id');
                openModal(rejeterModal, congeId);
            });
        });
        
        // Gestionnaires pour fermer les modales
        const closeButtons = document.querySelectorAll('.modal .close, .modal .btn-secondary');
        closeButtons.forEach(button => {
            button.addEventListener('click', function() {
                const modal = this.closest('.modal');
                closeModal(modal);
            });
        });
        
        // Fermer la modale en cliquant sur l'arrière-plan
        modalBackdrop.addEventListener('click', function() {
            const openModals = document.querySelectorAll('.modal.show');
            openModals.forEach(modal => {
                closeModal(modal);
            });
        });
        
        // Fermer la modale en appuyant sur Echap
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                const openModals = document.querySelectorAll('.modal.show');
                openModals.forEach(modal => {
                    closeModal(modal);
                });
            }
        });

        // Vérifier que le formulaire dans la modale fonctionne bien
        const approuverForm = document.getElementById('approuverForm');
        if (approuverForm) {
            approuverForm.addEventListener('submit', function(event) {
                // Vérification supplémentaire avant soumission
                const actionUrl = this.getAttribute('action');
                if (!actionUrl || actionUrl.includes('/0/')) {
                    event.preventDefault();
                    alert("Erreur: L'identifiant du congé n'a pas été correctement défini.");
                }
            });
        }

        const rejeterForm = document.getElementById('rejeterForm');
        if (rejeterForm) {
            rejeterForm.addEventListener('submit', function(event) {
                // Vérifier que le champ commentaire est rempli
                const commentaire = this.querySelector('textarea[name="commentaire"]').value;
                if (!commentaire || commentaire.trim() === '') {
                    event.preventDefault();
                    alert("Veuillez saisir un motif de refus.");
                }

                // Vérification supplémentaire avant soumission
                const actionUrl = this.getAttribute('action');
                if (!actionUrl || actionUrl.includes('/0/')) {
                    event.preventDefault();
                    alert("Erreur: L'identifiant du congé n'a pas été correctement défini.");
                }
            });
        }
    });
</script>
{% endblock %}