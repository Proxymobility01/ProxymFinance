{% extends 'base.html' %}
{% load static %}

{% block title %}Détails du Contrat{% endblock %}
{% block page_title %}Contrat: {{ contrat.reference }}{% endblock %}

{% block page_actions %}
<a href="{% url 'contrats:modifier_contrat_chauffeur' contrat.id %}" class="btn btn-warning">
    <i class="ti ti-edit"></i> Modifier
</a>
<a href="{% url 'contrats:ajouter_conge_pour_contrat' contrat.id %}" class="btn btn-info">
    <i class="ti ti-calendar-plus"></i> Demander un congé
</a>
<a href="{% url 'payments:paiement_rapide' contrat_type='chauffeur' contrat_id=contrat.id %}" class="btn btn-success">
    <i class="ti ti-cash-plus"></i> Enregistrer un paiement
</a>
<a href="{% url 'contrats:liste_contrats_chauffeur' %}" class="btn btn-secondary">
    <i class="ti ti-arrow-left"></i> Retour
</a>
{% endblock %}

{% block content %}
<div class="row">
    <!-- Information contrat -->
    <div class="col-md-4 mb-4">
    {# — Carte Informations du Contrat — #}
    <div class="card">
        <div class="card-header">
        <h3>Informations du Contrat</h3>
        </div>
        <div class="card-body">
        <div class="contrat-details">

            <div class="row mb-2">
            <div class="col-6 form-label text-left">
                <i class="ti ti-id"></i> Référence
            </div>
            <div class="col-6 text-left">
                {{ contrat.reference }}
            </div>
            </div>

            <div class="row mb-2">
            <div class="col-6 form-label text-left">
                <i class="ti ti-user"></i> Chauffeur
            </div>
            <div class="col-6 text-left">
                {% if contrat.association.validated_user %}
                    <a href="{% url 'contrats:details_chauffeur' contrat.association.validated_user.id %}">
                        {{ contrat.association.validated_user.nom }} {{ contrat.association.validated_user.prenom }}
                    </a>
                {% else %}
                    <span class="text-muted">Non attribué</span>
                {% endif %}

            </div>
            </div>

            <div class="row mb-2">
            <div class="col-6 form-label text-left">
                <i class="ti ti-motorbike"></i> Moto
            </div>
            <div class="col-6 text-left">
                {{ contrat.association.moto_valide.model }} ({{ contrat.association.moto_valide.vin|slice:"-6:" }})
            </div>
            </div>

            <div class="row mb-2">
            <div class="col-6 form-label text-left">
                <i class="ti ti-calendar"></i> Date signature
            </div>
            <div class="col-6 text-left">
                {{ contrat.date_signature|date:"d/m/Y" }}
            </div>
            </div>

            <div class="row mb-2">
            <div class="col-6 form-label text-left">
                <i class="ti ti-calendar-event"></i> Période
            </div>
            <div class="col-6 text-left">
                {{ contrat.date_debut|date:"d/m/Y" }} – {{ contrat.date_fin|date:"d/m/Y" }}
            </div>
            </div>

            <div class="row mb-2">
            <div class="col-6 form-label text-left">
                <i class="ti ti-calendar-stats"></i> Durée
            </div>
            <div class="col-6 text-left">
                {{ contrat.duree_semaines }} semaines
            </div>
            </div>

            <div class="row mb-2">
            <div class="col-6 form-label text-left">
                <i class="ti ti-coin"></i> Montant total
            </div>
            <div class="col-6 text-left">
                {{ contrat.montant_total|floatformat:0 }} FCFA
            </div>
            </div>

            <div class="row mb-2">
            <div class="col-6 form-label text-left">
                <i class="ti ti-cash"></i> Montant payé
            </div>
            <div class="col-6 text-left">
                {{ contrat.montant_paye|floatformat:0 }} FCFA
            </div>
            </div>

            <div class="row mb-2">
            <div class="col-6 form-label text-left">
                <i class="ti ti-cash-off"></i> Montant restant
            </div>
            <div class="col-6 text-left">
                {{ contrat.montant_restant|floatformat:0 }} FCFA
            </div>
            </div>

            <div class="row mb-2">
            <div class="col-6 form-label text-left">
                <i class="ti ti-calendar-time"></i> Fréquence
            </div>
            <div class="col-6 text-left">
                {{ contrat.get_frequence_paiement_display }}
            </div>
            </div>

            <div class="row mb-2">
             <div class="col-6 form-label text-left">
                <i class="ti ti-calendar-time"></i> Montant Normal par paiement
            </div>
            <div class="col-6 text-left">
                {{ contrat.montant_par_paiement|floatformat:0 }} FCFA
            </div>
            </div>

            <div class="row mb-2">
            <div class="col-6 form-label text-left">
                <i class="ti ti-receipt"></i> Montant par paiement auquel le chauffeur s'est engagé
            </div>
            <div class="col-6 text-left">
                {{ contrat.montant_engage|floatformat:0 }} FCFA
            </div>
            </div>

            <div class="row mb-2">
            <div class="col-6 form-label text-left">
                <i class="ti ti-battery-charging"></i> Caution batterie
            </div>
            <div class="col-6 text-left">
                {{ contrat.montant_caution_batterie|floatformat:0 }} FCFA ({{ contrat.duree_caution_batterie }} jours)
            </div>
            </div>

            <div class="row">
            <div class="col-6 form-label text-left">
                <i class="ti ti-status-change"></i> Statut
            </div>
            <div class="col-6 text-left">
                {% if contrat.statut == 'actif' %}
                <span class="badge badge-success">Actif</span>
                {% elif contrat.statut == 'terminé' %}
                <span class="badge badge-danger">Terminé</span>
                {% else %}
                <span class="badge badge-warning">Suspendu</span>
                {% endif %}
            </div>
            </div>

        </div>
        </div>
    </div>

    {# — Carte Garant — #}
    <div class="card mt-4">
        <div class="card-header">
        <h3>Garant</h3>
        </div>
        <div class="card-body">
        {% if contrat.garant %}
            <div class="garant-details">
            <div class="row mb-2">
                <div class="col-6 form-label text-left">
                <i class="ti ti-user"></i> Nom complet
                </div>
                <div class="col-6 text-left">
                <a href="{% url 'contrats:details_garant' contrat.garant.id %}">
                    {{ contrat.garant.prenom }} {{ contrat.garant.nom }}
                </a>
                </div>
            </div>
            <div class="row mb-2">
                <div class="col-6 form-label text-left">
                <i class="ti ti-id-badge"></i> Numéro CNI
                </div>
                <div class="col-6 text-left">
                {{ contrat.garant.numero_cni }}
                </div>
            </div>
            <div class="row mb-2">
                <div class="col-6 form-label text-left">
                <i class="ti ti-phone"></i> Téléphone
                </div>
                <div class="col-6 text-left">
                {{ contrat.garant.telephone }}
                </div>
            </div>
            <div class="row">
                <div class="col-6 form-label text-left">
                <i class="ti ti-building"></i> Occupation
                </div>
                <div class="col-6 text-left">
                {{ contrat.garant.occupation }}
                </div>
            </div>
            </div>
        {% else %}
            <div class="row">
            <div class="col-12 text-center py-3">
                <i class="ti ti-user-off" style="font-size:36px;opacity:0.5;"></i>
                <p class="mt-2">Aucun garant associé à ce contrat.</p>
            </div>
            </div>
        {% endif %}
        </div>
    </div>
    </div>

    
    <!-- Progression et Documents -->
    <div class="col-md-8">
        <div class="card mb-4">
            <div class="card-header">
                <h3>Progression du Contrat</h3>
            </div>
            <div class="card-body">
                <div class="progress mb-3" style="height: 25px;">
                    {% with pourcentage=contrat.montant_paye|floatformat:0|default:0 %}
                    <div class="progress-bar bg-primary" {% if contrat.montant_total > 0 %}style="width: {{ contrat.montant_paye|floatformat:0|default:'0'|stringformat:'s'|slice:':5' }}%"{% else %}style="width: 0%"{% endif %}>
                        {% if contrat.montant_total > 0 %}
                            {{ contrat.montant_paye|floatformat:0|default:'0'|stringformat:'s'|slice:':5' }}% payé
                        {% else %}
                            0% payé
                        {% endif %}
                    </div>
                    {% endwith %}
                  
                </div>
                
                <div class="row text-center">
                    <div class="col-4">
                        <h5>{{ contrat.montant_total|floatformat:0 }} FCFA</h5>
                        <p>Montant total</p>
                    </div>
                    <div class="col-4">
                        <h5>{{ contrat.montant_paye|floatformat:0 }} FCFA</h5>
                        <p>Montant payé</p>
                    </div>
                    <div class="col-4">
                        <h5>{{ contrat.montant_restant|floatformat:0 }} FCFA</h5>
                        <p>Montant restant</p>
                    </div>
                </div>
                
                <!-- Boutons actions -->
                <div class="mt-4 text-center">
                    <a href="{% url 'payments:paiement_rapide' 'chauffeur' contrat.id %}{% if contrat.contrat_batterie_id %}?contrat_batterie_id={{ contrat.contrat_batterie_id }}{% endif %}" class="btn btn-primary">
                        <i class="ti ti-cash-plus"></i> Enregistrer un paiement
                    </a>
                    {% if contrat.statut == 'actif' %}
                        <a href="#" class="btn btn-warning">
                            <i class="ti ti-player-pause"></i> Suspendre
                        </a>
                    {% elif contrat.statut == 'suspendu' %}
                        <a href="#" class="btn btn-success">
                            <i class="ti ti-player-play"></i> Réactiver
                        </a>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <!-- Paiements et Pénalités -->
        <div class="card mb-4">
            <div class="card-header">
                <ul class="nav nav-tabs card-header-tabs" id="contractTabs" role="tablist">
                    <li class="nav-item">
                        <a class="nav-link active" id="payments-tab" data-toggle="tab" href="#payments" role="tab" aria-controls="payments" aria-selected="true">
                            <i class="ti ti-cash"></i> Paiements
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" id="penalties-tab" data-toggle="tab" href="#penalties" role="tab" aria-controls="penalties" aria-selected="false">
                            <i class="ti ti-alert-triangle"></i> Pénalités
                        </a>
                    </li>
                </ul>
            </div>
            <div class="card-body">
                <div class="tab-content" id="contractTabsContent">
                    <!-- Onglet Paiements -->
                    <div class="tab-pane fade show active" id="payments" role="tabpanel" aria-labelledby="payments-tab">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h5>Historique des paiements</h5>
                            <a href="{% url 'payments:paiement_rapide' 'chauffeur' contrat.id %}" class="btn btn-primary">
                                <i class="ti ti-plus"></i> Nouveau paiement
                            </a>
                        </div>
                        
                        {% if contrat.paiements.all %}
                            <div class="table-responsive">
                                <table class="table table-striped table-hover">
                                    <thead>
                                        <tr>
                                            <th>Date</th>
                                            <th>Référence</th>
                                            <th>Montant</th>
                                            <th>Méthode</th>
                                            <th>Type</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for paiement in contrat.paiements.all|dictsortreversed:"date_paiement" %}
                                            <tr>
                                                <td>{{ paiement.date_paiement|date:"d/m/Y" }}</td>
                                                <td>{{ paiement.reference }}</td>
                                                <td>{{ paiement.montant|floatformat:0 }} FCFA</td>
                                                <td>{{ paiement.get_methode_paiement_display }}</td>
                                                <td>
                                                    {% if paiement.est_penalite %}
                                                        <span class="badge badge-danger">Pénalité</span>
                                                    {% else %}
                                                        <span class="badge badge-success">Standard</span>
                                                    {% endif %}
                                                </td>
                                            </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        {% else %}
                            <div class="alert alert-info">
                                <i class="ti ti-info-circle"></i> Aucun paiement enregistré pour ce contrat.
                            </div>
                        {% endif %}
                    </div>
                    
                   
                </div>
            </div>
        </div>
        
        <!-- Documents -->
        <div class="card mb-4">
            <div class="card-header">
                <h3>Documents</h3>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <div class="card mb-3">
                            <div class="card-body text-center">
                                <i class="ti ti-file-contract" style="font-size: 36px;"></i>
                                <h5 class="mt-2">Contrat physique</h5>
                                {% if contrat.contrat_physique %}
                                    <a href="{{ contrat.contrat_physique.url }}" class="btn btn-sm btn-primary mt-2" target="_blank">
                                        <i class="ti ti-download"></i> Télécharger
                                    </a>
                                {% else %}
                                    <p class="text-muted">Non disponible</p>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Congés -->
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h3>Congés</h3>
                <a href="{% url 'contrats:ajouter_conge_pour_contrat' contrat.id %}" class="btn btn-sm btn-primary">
                    <i class="ti ti-plus"></i> Demander un congé
                </a>
            </div>
            <div class="card-body">
                <!-- [Reste du code des congés inchangé...] -->
                <!-- J'ai conservé votre implémentation des congés car elle semble déjà complète -->
                
                <div class="row text-center mb-4">
                    <div class="col-4">
                        <div class="card bg-info text-white">
                            <div class="card-body">
                                <h4>{{ contrat.jours_conges_total }}</h4>
                                <p>Jours totaux</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-4">
                        <div class="card bg-warning text-dark">
                            <div class="card-body">
                                <h4>{{ contrat.jours_conges_utilises }}</h4>
                                <p>Jours utilisés</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-4">
                        <div class="card bg-success text-white">
                            <div class="card-body">
                                <h4>{{ contrat.jours_conges_restants }}</h4>
                                <p>Jours restants</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                {% if conges %}
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Période</th>
                                    <th>Jours</th>
                                    <th>Statut</th>
                                    <th>Date demande</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for conge in conges %}
                                <tr>
                                    <td>{{ conge.date_debut|date:"d/m/Y" }} - {{ conge.date_fin|date:"d/m/Y" }}</td>
                                    <td>{{ conge.nombre_jours }}</td>
                                    <td>
                                        {% if conge.statut == 'en_attente' %}
                                            <span class="badge badge-warning">En attente</span>
                                        {% elif conge.statut == 'approuvé' %}
                                            <span class="badge badge-success">Approuvé</span>
                                        {% elif conge.statut == 'planifié' %}
                                            <span class="badge badge-info">Planifié</span>
                                        {% elif conge.statut == 'en_cours' %}
                                            <span class="badge badge-primary">En cours</span>
                                        {% elif conge.statut == 'terminé' %}
                                            <span class="badge badge-secondary">Terminé</span>
                                        {% elif conge.statut == 'annulé' %}
                                            <span class="badge badge-danger">Annulé</span>
                                        {% elif conge.statut == 'rejeté' %}
                                            <span class="badge badge-danger">Rejeté</span>
                                        {% endif %}
                                    </td>
                                    <td>{{ conge.date_demande|date:"d/m/Y" }}</td>
                                    <td>
                                        <a href="{% url 'contrats:details_conge' conge.id %}" class="btn btn-sm btn-info" title="Détails">
                                            <i class="ti ti-eye"></i>
                                        </a>
                                        {% if conge.statut == 'en_attente' %}
                                            <button type="button" class="btn btn-sm btn-success" data-toggle="modal" data-target="#approuverCongeModal{{ conge.id }}" title="Approuver">
                                                <i class="ti ti-check"></i>
                                            </button>
                                            <button type="button" class="btn btn-sm btn-danger" data-toggle="modal" data-target="#rejeterCongeModal{{ conge.id }}" title="Rejeter">
                                                <i class="ti ti-x"></i>
                                            </button>
                                        {% endif %}
                                    </td>
                                </tr>
                                
                                <!-- Modal Approuver -->
                                <div class="modal fade" id="approuverCongeModal{{ conge.id }}" tabindex="-1" role="dialog" aria-hidden="true">
                                    <div class="modal-dialog" role="document">
                                        <div class="modal-content">
                                            <div class="modal-header">
                                                <h5 class="modal-title">Approuver la demande de congé</h5>
                                                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                                    <span aria-hidden="true">&times;</span>
                                                </button>
                                            </div>
                                            <form action="{% url 'contrats:modifier_statut_conge' conge.id %}?contrat_id={{ contrat.id }}" method="post">
                                                {% csrf_token %}
                                                <div class="modal-body">
                                                    <input type="hidden" name="statut" value="approuvé">
                                                    <div class="form-group">
                                                        <label for="commentaire{{ conge.id }}">Commentaire (optionnel):</label>
                                                        <textarea id="commentaire{{ conge.id }}" name="commentaire" class="form-control" rows="3"></textarea>
                                                    </div>
                                                </div>
                                                <div class="modal-footer">
                                                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Annuler</button>
                                                    <button type="submit" class="btn btn-success">Approuver</button>
                                                </div>
                                            </form>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Modal Rejeter -->
                                <div class="modal fade" id="rejeterCongeModal{{ conge.id }}" tabindex="-1" role="dialog" aria-hidden="true">
                                    <div class="modal-dialog" role="document">
                                        <div class="modal-content">
                                            <div class="modal-header">
                                                <h5 class="modal-title">Rejeter la demande de congé</h5>
                                                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                                    <span aria-hidden="true">&times;</span>
                                                </button>
                                            </div>
                                            <form action="{% url 'contrats:modifier_statut_conge' conge.id %}?contrat_id={{ contrat.id }}" method="post">
                                                {% csrf_token %}
                                                <div class="modal-body">
                                                    <input type="hidden" name="statut" value="rejeté">
                                                    <div class="form-group">
                                                        <label for="commentaire_rejet{{ conge.id }}">Motif de refus:</label>
                                                        <textarea id="commentaire_rejet{{ conge.id }}" name="commentaire" class="form-control" rows="3" required></textarea>
                                                    </div>
                                                </div>
                                                <div class="modal-footer">
                                                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Annuler</button>
                                                    <button type="submit" class="btn btn-danger">Rejeter</button>
                                                </div>
                                            </form>
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                        <div class="text-center py-4">
                            <i class="ti ti-calendar-off" style="font-size: 48px; opacity: 0.5;"></i>
                            <p class="mt-3">Aucun congé enregistré pour ce contrat.</p>
                            <a href="{% url 'contrats:ajouter_conge_pour_contrat' contrat.id %}" class="btn btn-primary mt-2">
                                <i class="ti ti-plus"></i> Demander un congé
                            </a>
                        </div>
                    {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Initialisation des modals
        const modalTriggers = document.querySelectorAll('[data-toggle="modal"]');
        modalTriggers.forEach(trigger => {
            trigger.addEventListener('click', function() {
                const targetId = this.getAttribute('data-target');
                const modal = document.querySelector(targetId);
                if (modal) {
                    modal.classList.add('show');
                    modal.style.display = 'block';
                    document.body.classList.add('modal-open');
                }
            });
        });
        
        // Fermeture des modals
        const closeButtons = document.querySelectorAll('.modal .close, .modal .btn-secondary');
        closeButtons.forEach(button => {
            button.addEventListener('click', function() {
                const modal = this.closest('.modal');
                if (modal) {
                    modal.classList.remove('show');
                    modal.style.display = 'none';
                    document.body.classList.remove('modal-open');
                }
            });
        });
    });
</script>
{% endblock %}